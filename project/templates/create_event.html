{% extends "layout.html" %}

{% block title %}
    Event Creation
{% endblock %}

{% block main %}
    <form action="/create-event" method="post" class="row g-3 align-items-left">

        <!-- Focus selection -->
        <div class="col-auto text-start">
            <label for="focus-options" class="form-label mb-2 ms-2"><b>Outline focus:</b></label>
            <select name="focus" id="focus-options" class="form-select rounded-pill py-2 px-3 selector">
                {% for focus in focuses %}
                    <option value="{{ focus }}">{{ focus }}</option>
                {% endfor %}
            </select>
            <p class="feedback mt-2 mb-0">{{ focus_fb | default('') }}</p>
        </div>

        <!-- Setting selection -->
        <div class="col-auto text-start">
            <label for="setting-options" class="form-label mb-2 ms-2"><b>Pick setting:</b></label>
            <select name="setting" id="setting-options" class="form-select rounded-pill py-2 px-3 selector">
                {% for setting in settings %}
                    <option value="{{ setting }}">{{ setting }}</option>
                {% endfor %}
            </select>
            <p class="feedback mt-2 mb-0">{{ setting_fb | default('') }}</p>
        </div>
        <hr>

        <!-- Date picker adapted from: Codeply -->
        <!-- URL: https://codeply.com/p/zU0EWDmIfn -->
        <!-- Created by skelly -->
        <!-- Start Date -->
        <div class="col-auto text-start">
            <label for="start-d" class="form-label mb-2 ms-2"><b>Start date:</b></label>
            <div class="input-group rounded-pill border border-1 overflow-hidden py-1 px-4 dp-div c-w-200">
                <input
                    id="start-d"
                    class="form-control border-0 outline-erase"
                    type="date"
                    name="start-date"/>
            </div>
            <p class="feedback mt-2 mb-0">{{ date_fb | default('') }}</p>
        </div>

        <!-- End Date -->
        <div class="col-auto text-start">
            <label for="end-d" class="form-label mb-2 ms-2"><b>End date:</b></label>
            <div class="input-group rounded-pill border border-1 overflow-hidden py-1 px-4 dp-div c-w-200">
                <input
                    id="end-d"
                    class="form-control border-0 outline-erase"
                    type="date"
                    name="end-date"/>
            </div>
        </div>
        <hr>

        <!-- Activity table -->
        <div class="col-auto text-start">
            <p class="mb-2 ms-2"><b>Activity outline:</b></p>
            <div id="tables-wrapper" class="d-flex flex-wrap gap-3 d-flex justify-content-start align-items-center col-auto">
                <!-- First Table -->
                <table class="table table-bordered m-0 flex-grow-0 flex-shrink-0 activity-table c-w-200" data-index="0">
                    <thead>
                        <tr>
                            <td><input type="text" class="form-control" name="topic" placeholder="Activity"></td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="form-control" name="ideas[0][]" placeholder="option 1"></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="form-control" name="ideas[0][]" placeholder="option 2"></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Buttons -->
                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0" id="btn-div">
                    <!-- Plus Button -->
                    <button id="add-col-btn" type="button" class="btn btn-secondary btn-sm rounded-circle align-self-center ms-2 py-2">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <!-- Remove Button -->
                    <button id="rmv-col-btn" type="button" class="btn btn-danger btn-sm rounded-circle align-self-center ms-2 py-2">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                </div>
            </div>
            <p class="feedback mt-2 mb-0">{{ table_fb | default('') }}</p>
        </div>
        <hr>

        <!-- Minimum Attendees -->
        <div class="col-auto text-start">
            <label for="participants-min" class="form-label mb-2 ms-2"><b>Minimum attendees:</b></label>
            <input class="form-control mx-auto w-auto rounded-pill py-2 px-4 c-w-200" name="min-participants"
                   placeholder="Type a number" type="number" id="participants-min">
            <p class="feedback mt-2 mb-0">{{ limit_fb | default('') }}</p>
        </div>

        <!-- Expected participants -->
        <div class="col-auto text-start">
            <label for="participants-max" class="form-label mb-2 ms-2"><b>Total participants:</b></label>
            <input class="form-control mx-auto w-auto rounded-pill py-2 px-4 c-w-200" name="max-participants"
                   placeholder="Type a number" type="number" id="participants-max">
            <p class="feedback mt-2 mb-0">{{ max_fb | default('') }}</p>
        </div>
        <hr>

        <!-- Submit button -->
        <div class="col-auto text-start">
            {% if invite_link %}
                <a href="/" class="btn btn-secondary rounded-pill px-4 pb-2 py-2">Back to Dashboard</a>
            {% else %}
                <button class="btn btn-primary rounded-pill px-4 py-2 mt-3" type="submit">Submit</button>
            {% endif %}
        </div>

    </form>

    <!-- Invite Modal adapted from: Bootstrap documentation -->
    <!-- URL: https://getbootstrap.com/docs/4.0/components/modal/ -->
    <!-- URL: https://getbootstrap.com/docs/5.3/components/modal/#via-javascript -->
    <div class="modal fade" id="invite-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Section 1: Header -->
                <div class="modal-header">
                    <h5 class="modal-title ms-2">Event created successfully!üëè</h5>
                    <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Section 2: Body -->
                <div class="modal-body">
                    <p class="text-start ms-2">Share this with friends.</p>
                    <div class="input-group">
                        <input type="text" id="invite-link" class="form-control rounded-start-pill" value="{{ invite_link }}" readonly>
                        <button class="btn btn-primary rounded-end-pill px-3 pb-2 py-2" type="button" id="copy-btn">Copy link</button>
                    </div>
                </div>

                <!-- Section 3: Footer -->
                <div class="modal-footer">
                    <a href="/" class="btn btn-secondary rounded-pill px-4 pb-2 py-2">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const addBtn = document.getElementById("add-col-btn");
            const rmvBtn = document.getElementById("rmv-col-btn");
            const btnDiv = document.getElementById("btn-div");

            const wrapper = document.getElementById("tables-wrapper");
            const maxTables = 5;
            const minTables = 1;

            addBtn.addEventListener("click", () => {
                // Set clone limit and alert user
                const currentTables = wrapper.querySelectorAll(".activity-table").length;
                if (currentTables >= maxTables) {
                    alert(`You can only add up to ${maxTables} tables.`);
                    return;
                }

                // Adapted from: W3 schools tutorials
                // URL: https://www.w3schools.com/jsref/met_node_insertbefore.asp
                // Clone table
                const firstTable = wrapper.querySelector(".activity-table");
                const newTable = firstTable.cloneNode(true);

                // Assign new index
                const newIndex = currentTables;
                newTable.setAttribute("data-index", newIndex);

                // Clear inputs and update names for backend
                // Guidance by ChatGPT (OpenAI)
                newTable.querySelectorAll("input").forEach((input) => {
                    input.value = "";
                    if (input.name.startsWith("ideas[")) {
                        input.name = `ideas[${newIndex}][]`;
                    }
                });

                // Insert table before the button section
                wrapper.insertBefore(newTable, btnDiv);
            });

            rmvBtn.addEventListener("click", () => {
                // Set delete limit and alert user
                const currentTables = wrapper.querySelectorAll(".activity-table").length;
                if (currentTables <= minTables) {
                    alert("You cannot delete the last table.");
                    return;
                }

                // Select and remove the last table
                const lastTable = wrapper.querySelectorAll(".activity-table")[currentTables - 1];
                lastTable.remove();
            });

            // Show modal only when link is generated
            {% if invite_link %}
                // JS adapted from: Bootstrap documentation
                // URL: https://getbootstrap.com/docs/5.3/components/modal/#via-javascript
                const inviteModal = new bootstrap.Modal(document.getElementById("invite-modal"));
                inviteModal.show();

                // Adapted from: W3 schools tutorials
                // URL: https://www.w3schools.com/howto/howto_js_copy_clipboard.asp
                // Let user copy link
                const copyBtn = document.getElementById("copy-btn");
                copyBtn.addEventListener("click", () => {
                    // Get the text field
                    const copyLink = document.getElementById("invite-link");
                    // Select the text field
                    copyLink.select();
                    copyLink.setSelectionRange(0, 99999); // For mobile devices
                    // Copy the link inside the text field
                    navigator.clipboard.writeText(copyLink.value);
                    alert("Link copied!");
                });
            {% endif %}
        });
    </script>
{% endblock %}
